# Результаты

Исходные `.las` обработаны с помощью методов топологического анализа.
Выявлены зоны интереса и сохранены в векторные файлы, ссылка: https://drive.google.com/file/d/1TjZvach26hDjxTT3F5_h7BSYMu1yG8YX/view?usp=sharing

Использовалось 3 разных метода анализа, каждый даёт лучше результаты для разных задач:
- `fromZero` - высота анализируется "снизу-вверх". Чаще всего при таком подходе определяются углубления.
- `fromMax` - анализ производится сверху вниз, позволяя лучше определить возвышенности и бугры.
- `radius` - сперва выделяются объекты из точек со схожей высотой, затем они расширяются.

Использованный код обработки хранится в файле `main.py` в виде набора функций.
Для получения shape файла из карты высот, необходимо вызвать функцию `process_las_file` и передать туда путь к исходному файлу, выходной путь и экземпляра объекта с настройками чтения и обработки `LasReaderSetup`. Пример работы также есть в `main.py`. Для обработки сразу нескольких файлов с облаком точек есть функция `process_multiple_files`.

## Поиск нужных объектов
У каждого объекта в shape файле есть свойства:
* id - уникальный идентификатор в чанке
* ParentID - идентификатор родительского объекта. Если нету, то показатель равен 4294967295
* Depth - показатель глубины. У самой верхней (без родительской) равен 1
* Start - время появления объекта. Для fromZero и fromMax - выражается в показатели высоты, от которого объект начал разрастаться; для radius - показатель схожести начальный точек в компоненте
* End - время исчезновения объекта. Для fromZero и fromMax - выражается в показатели высоты, от которого объект начал разрастаться; для radius - показатель схожести конечных точек
* NumPoints - количество точек в объекте

По данным свойствам можно производить фильтрации. Для это сначала убираются слишком малые и слишком большие компоненты, т.к. они мешают визуализации:
```SQL
"NumPoints" < 1000000 and "NumPoints" > 100
```

Затем производится точечный поиск
---
Слой *Ground_2020_Участок 1* из папки *radius*
Следующий фильтр выделит дорогу:
```SQL
"Start" = 0
AND to_real("End") >= 17204 AND to_real("End") <= 17413.33398
AND "NumPoints" >= 82461 AND "NumPoints" <= 112220
AND "Depth" IN (2, 3)
AND area($geometry) < 1000000
```

---
Слой *2020_1 без классификации_ч1* из папки *fromMax*
Следующий фильтр выделит кочкообразные элементы:
```SQL
NumPoints" >= 2000 AND "NumPoints" <= 210000
AND to_real("Start") >= 20100
AND (
    "End" = -9999 OR (to_real("End") >= 17400 AND to_real("End") <= 30000)
)
AND "Depth" IN (2, 3, 4)
```

---
Слой *2020_1 без классификации_ч2* из папки *fromMax*
Следующий фильтр выделит малые (шумовые) объекты:
```SQL
"Depth" > 2
 and "NumPoints" <= 26000
```


## Как работает алгоритм определения объектов
1. Открывается las файл
2. Файл читается по тайлам с наложением
3. Точки от тайла сужаются и проецируются на матрицу
4. По матрице строится топологчисеская характеристика
5. Их характеристики извлекаются найденные объекты
6. Объекты векторизируются и проецируются по системе координат файла
7. Найденные объекты фильтруются и записываются в выходной файл

## Пример использования через утилиту

Запустить утилиту с аргументами:
LasTopoDec "LiDAR_BIGDATA_GN/Ground_2020_Участок 1.las" output.shp

## Запуск через Python
1. Установить python версии не ниже 3.11
2. Установить зависимости: `pip install -r requirements.txt`
3. Запустить main.py или использовать его в своём скрипте. Пример:

```python
preferences = LasReaderSetup()

# В las точки неравномерны, между x1 и x10 может быть 3-5 точек,
# поэтому нужно уменьшить размерность
preferences.aproximateRectSize = 10

# Целиком обработка файла слишком затратна из-а большого размера
# Для выполнения обработки на обычном компьютере необходимо разбить на чанки
# Размер указывается в пикселях после уменьшения размерности
preferences.chunkSize = 1500

# Так как важные объекты могут быть на границе чанка, нужно брать с захлёстом
# В идеале размер нахлёста - максимальный размер объекта
preferences.chunkOversize = 100

preferences.procType = bc.ProcType.Radius

# True - Пропускать отсутствующие данные, тогда в обарботки используются только существующие точки (области точек
# False - подставлять на место отсутствующих точек значение по умолчанию (-9999 или 9999)
preferences.useMask = False

process_las_file(las_file_path, output, preferences)
```

## Проекция растра

Чтобы привязать изображение к las файлу, написан скрипт `bind_image.py`
